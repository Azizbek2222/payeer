<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <title>Tosh Tashlash O'yini</title>
    <style>
        /* Asosiy Dizayn - index.html ga mos, ammo yanada ko'k-binafsha */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #16222A, #3A6073); 
            padding: 10px;
            margin: 0;
            min-height: 100vh;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* === EKRA SURILMASLIGI UCHUN QO'SHIMCHA QATORLAR === */
            overflow: hidden; 
            box-sizing: border-box;
            /* ================================================== */
        }

        .container {
            max-width: 400px;
            width: 95%;
            margin: 30px auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            text-align: center;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            /* Markazga joylashtirishni yaxshilash */
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin: auto; /* Vertikal joylashuvni markazlashtirish uchun */
        }

        h2 {
            color: #FFD700;
            margin-bottom: 20px;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.5);
        }

        /* O'yin maydoni */
        .coin-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
            min-height: 150px; /* Joy ajratish */
        }
        
        /* Tangani vizualizatsiya qilish */
        #coin-display {
            width: 100px;
            height: 100px;
            background: #f0c420; /* Oltin rang */
            border-radius: 50%;
            border: 5px solid #fff;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
            line-height: 90px;
            font-size: 30px;
            font-weight: bold;
            color: #2c3e50;
            transition: transform 0.5s ease-in-out;
            margin-bottom: 20px;
            /* Yaxshiroq rasm o'rniga oddiy belgi */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .coin-head {
             background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%232c3e50" d="M12 2A10 10 0 0 0 2 12A10 10 0 0 0 12 22A10 10 0 0 0 22 12A10 10 0 0 0 12 2M12 4A8 8 0 0 1 20 12A8 8 0 0 1 12 20A8 8 0 0 1 4 12A8 8 0 0 1 12 4M12 5C9.24 5 7 7.24 7 10H9C9 8.34 10.34 7 12 7C13.66 7 15 8.34 15 10C15 12.5 12 12.25 12 15H14C14 13.5 17 13.75 17 10C17 7.24 14.76 5 12 5M11 16H13V18H11V16Z" /></svg>');
             background-size: 60px;
             background-repeat: no-repeat;
             background-position: center;
             line-height: 0;
             color: transparent;
        }

        .coin-tail {
            content: '1';
             line-height: 100px;
        }

        /* Animatsiya */
        .spin {
            animation: coinFlip 1s ease-in-out infinite alternate;
        }
        @keyframes coinFlip {
            0% { transform: rotateY(0deg) scale(1); }
            100% { transform: rotateY(180deg) scale(1.1); }
        }

        /* Forma Elementlari */
        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="number"], select {
            flex-grow: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #444;
            background: #34495e;
            color: #fff;
            box-sizing: border-box;
            font-size: 16px;
        }

        .action-btn {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s, transform 0.1s;
        }
        .action-btn:active {
            transform: scale(0.98);
        }
        .action-btn:disabled {
            background: #555;
            cursor: not-allowed;
        }

        /* Natija Xabari */
        #game-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            min-height: 40px;
        }
        .win { background: #00c16e50; color: #00FFC0; }
        .lose { background: #e74c3c50; color: #FF5555; }
        
        .balance-info {
            background: rgba(255, 255, 255, 0.15);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 15px;
        }

        .back-btn {
            position: absolute; top: 15px; left: 15px;
            padding: 8px 15px;
            background: #f0f0f0;
            color: #34495e;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            /* === QO'SHILGAN QATOR: Tugma ustunligini oshirish === */
            z-index: 100;
            /* =================================================== */
        }
    </style>
</head>
<body>

<button class="back-btn" onclick="location.href='games.html'">‚Üê Orqaga</button>

<div class="container">
    <h2>ü™ô Tosh Tashlash O'yini</h2>
    
    <div class="balance-info">
        Joriy Balansingiz: <span id="current-balance">0.00</span> so'm
    </div>

    <div class="coin-area">
        <div id="coin-display" class="coin-head"></div>
        <div id="loading-spinner" style="display: none; color: #FFD700;">Tashlanmoqda...</div>
    </div>
    
    <div class="form-row">
        <input type="number" id="bet-amount" min="1" step="1" value="10" placeholder="Tikish miqdori (so'm)">
        <select id="bet-choice">
            <option value="heads">Tosh (Gerb)</option>
            <option value="tails">Raqam</option>
        </select>
    </div>
    
    <button class="action-btn" id="play-game-btn" onclick="playCoinFlip()">O'ynash (x2 yutuq)</button>
    <p id="game-message"></p>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

// === FIREBASE KONFIGURATSIYASI ===
// DIQQAT: Sizning real Firebase sozlamalaringizni qo'ying
const firebaseConfig = {
  apiKey: "AIzaSyDIeG8dVbm0Yk7FR1hPzrBoD7rgDKWAFoY",
  authDomain: "user1111-c84a0.firebaseapp.com",
  databaseURL: "https://user1111-c84a0-default-rtdb.firebaseio.com",
  projectId: "user1111-c84a0",
  storageBucket: "user1111-c84a0.firebaseapp.com",
  messagingSenderId: "901723757936",
  appId: "1:901723757936:web:9da0a1c7ec494f4a0c03b5",
  measurementId: "G-9R8ZQY63B1"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dbRef = ref(db);

let deviceId = localStorage.getItem("deviceId");
if(!deviceId){
    deviceId = "user_"+Math.random().toString(36).substr(2,9);
    localStorage.setItem("deviceId", deviceId);
}

const balanceEl = document.getElementById('current-balance');
const coinDisplay = document.getElementById('coin-display');
const gameMessageEl = document.getElementById('game-message');
const playBtn = document.getElementById('play-game-btn');
const loadingSpinner = document.getElementById('loading-spinner');

// === Balansni yuklash funksiyasi ===
async function loadBalance() {
    try {
        const userSnapshot = await get(ref(db, "users/" + deviceId));
        if (userSnapshot.exists()) {
            const balance = parseFloat(userSnapshot.val().balance || 0).toFixed(2);
            balanceEl.innerText = balance;
            return parseFloat(balance);
        } else {
            // Agar foydalanuvchi mavjud bo'lmasa, uni yaratish
            await update(ref(db, "users/" + deviceId), { balance: 0.00, launchCount: 0 });
            balanceEl.innerText = "0.00";
            return 0.00;
        }
    } catch (error) {
        console.error("Balansni yuklashda xatolik:", error);
        balanceEl.innerText = "Xatolik";
        return 0;
    }
}

// === O'yinni boshlash funksiyasi ===
window.playCoinFlip = async function() {
    
    // Tugmani va xabarni tozalash
    playBtn.disabled = true;
    gameMessageEl.innerText = '';
    gameMessageEl.className = '';
    coinDisplay.classList.remove('coin-head', 'coin-tail'); // Oldingi rasmni o'chirish
    
    const betAmountInput = document.getElementById('bet-amount');
    const betChoiceSelect = document.getElementById('bet-choice');
    
    const betAmount = parseInt(betAmountInput.value);
    const userChoice = betChoiceSelect.value;
    
    // 1. Kirishni tekshirish
    if (isNaN(betAmount) || betAmount < 1) {
        gameMessageEl.innerText = "Tikish miqdorini 1 so'mdan kam bo'lmagan butun son kiriting.";
        gameMessageEl.className = 'lose';
        playBtn.disabled = false;
        return;
    }
    
    // 2. Balansni tekshirish
    const currentBalance = await loadBalance();
    
    if (currentBalance < betAmount) {
        gameMessageEl.innerText = `Balansingizda mablag' yetarli emas. Joriy balans: ${currentBalance.toFixed(2)} so'm.`;
        gameMessageEl.className = 'lose';
        playBtn.disabled = false;
        return;
    }
    
    // === ANIMATSIYA BOSHLANISHI ===
    coinDisplay.classList.add('spin');
    loadingSpinner.style.display = 'block';
    
    // 3. O'yin mantiqi (50/50)
    const result = Math.random() < 0.5 ? 'heads' : 'tails';
    const resultText = result === 'heads' ? 'Tosh (Gerb)' : 'Raqam';
    
    // 4. Natijani hisoblash
    let newBalance = currentBalance;
    let message = "";
    
    await new Promise(resolve => setTimeout(resolve, 2000)); // 2 sekund kutish
    
    // === ANIMATSIYA TUGASHI ===
    coinDisplay.classList.remove('spin');
    loadingSpinner.style.display = 'none';
    
    if (userChoice === result) {
        // YUTDI (1:1 yutuq)
        newBalance += betAmount;
        message = `ü•≥ G'alaba! ${resultText} chiqdi. Siz ${betAmount.toFixed(2)} so'm yutdingiz!`;
        gameMessageEl.className = 'win';
    } else {
        // YUTQAZDI
        newBalance -= betAmount;
        message = `üò¢ Mag'lubiyat. ${resultText} chiqdi. ${betAmount.toFixed(2)} so'm yutqazdingiz.`;
        gameMessageEl.className = 'lose';
    }
    
    // Tangani yakuniy holatini ko'rsatish
    coinDisplay.classList.add(result === 'heads' ? 'coin-head' : 'coin-tail');
    
    // 5. Firebase'da balansni yangilash
    try {
        await update(ref(db, "users/" + deviceId), { 
            balance: parseFloat(newBalance.toFixed(2)) 
        });
        
        // 6. Xabarni ko'rsatish va balansni yangilash
        gameMessageEl.innerHTML = message;
        balanceEl.innerText = newBalance.toFixed(2);

    } catch (error) {
        gameMessageEl.innerText = "Ma'lumotlar bazasini yangilashda xatolik yuz berdi.";
        gameMessageEl.className = 'lose';
        console.error("Coin Flip Xatolik:", error);
    }
    
    playBtn.disabled = false;
}

window.onload = loadBalance;
</script>

</body>
</html>
