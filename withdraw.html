<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta charset="UTF-8">
<title>Withdraw Money</title>
<style>
    /* Umumiy dizayn - Ko'k shaffof fon */
    body { 
        font-family: Arial, sans-serif; 
        background: linear-gradient(135deg, rgba(78, 159, 255, 0.9), rgba(106, 201, 255, 0.9)); 
        text-align: center; 
        padding-top: 60px; 
        color: #fff; /* Oq rangli matn */
        min-height: 100vh;
        margin: 0;
    }
    .withdraw-box{
        background: rgba(255, 255, 255, 0.9); /* Oq shaffoflik */
        width: 300px;
        margin: auto;
        padding: 30px;
        border-radius: 14px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        color: #333; /* Qora matn */
    }
    .box-title{
        font-size: 26px;
        font-weight: bold;
        margin-bottom: 25px;
        color: #007bff;
        text-shadow: 1px 1px 1px rgba(0,0,0,0.1);
    }
    /* Select va Input stillari */
    select, input[type="text"], input[type="number"] {
        width: 100%;
        padding: 12px;
        margin: 10px 0;
        display: inline-block;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-sizing: border-box;
        font-size: 16px;
        background-color: #f9f9f9;
    }
    /* Yechib olish turini tanlash uchun */
    #withdrawType {
        font-weight: bold;
    }
    /* Submit tugmasi */
    .submit-btn{
        margin-top: 20px;
        padding: 14px 28px;
        background: linear-gradient(135deg,#00c16e,#00e689);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 18px;
        font-weight: bold;
        box-shadow: 0 6px 15px rgba(0,200,120,0.4);
        cursor: pointer;
        width: 100%;
        transition: background-color 0.3s;
    }
    .submit-btn:hover {
        background: linear-gradient(135deg,#00e689,#00c16e);
    }
    /* Orqaga tugmasi */
    .back-btn {
        margin-top: 15px;
        padding: 10px 20px;
        background: #f0f0f0;
        color: #007bff;
        border: 1px solid #007bff;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .back-btn:hover {
        background: #e6e6e6;
    }
</style>
</head>
<body>
<div class="withdraw-box">
    <div class="box-title">ðŸ’¸ Withdraw Money</div>
    <form id="withdrawForm">
        
        <label for="withdrawType" style="display: block; text-align: left; margin-top: 10px; font-weight: bold;">Select withdrawal type:</label>
        <select id="withdrawType" required>
            <option value="">--- Choose ---</option>
            <option value="uzcard_humo">ðŸ‡ºðŸ‡¿ Uzbekistan Card (Humo/Uzcard)</option>
            <option value="faucetpay">ðŸª™ FaucetPay E-mail</option>
        </select>
        
        <div id="uzcardHumoFields" style="display:none;">
            <input type="text" id="cardNumber" placeholder="Humo yoki Uzcard raqamingizni kiriting" maxlength="16">
        </div>

        <div id="faucetpayFields" style="display:none;">
            <input type="text" id="faucetpayEmail" placeholder="Enter your FaucetPay Email Address">
        </div>
        
        <input type="number" id="amount" placeholder="Quantity (USDT)" min="0.01" step="0.01" required><br>
        
        <p id="minAmountInfo" style="font-size: 12px; color: #666; text-align: left; margin-top: -5px;">Minimum withdrawal amount: **Choose**</p>

        <button type="submit" class="submit-btn">Send a request</button>
    </form>
    <button class="back-btn" onclick="location.href='index.html'">Back</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, push, get, child, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    // index.html dan olingan Firebase konfiguratsiyasi
    const firebaseConfig = {
      apiKey: "AIzaSyDIeG8dVbm0Yk7FR1hPzrBoD7rgDKWAFoY",
      authDomain: "user1111-c84a0.firebaseapp.com",
      databaseURL: "https://user1111-c84a0-default-rtdb.firebaseio.com",
      projectId: "user1111-c84a0",
      storageBucket: "user1111-c84a0.firebasestorage.app",
      messagingSenderId: "901723757936",
      appId: "1:901723757936:web:9da0a1c7ec494f4a0c03b5",
      measurementId: "G-9R8ZQY63B1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db);
    
    // index.html dan olingan deviceId ni olish
    let deviceId = localStorage.getItem("deviceId");
    if(!deviceId){
        alert("Foydalanuvchi identifikatori topilmadi. Iltimos, avval index.html ni oching.");
        window.location.href = "index.html";
    }
    
    const MIN_WITHDRAWAL_CARD = 1.00; // $1.00 karta uchun
    const MIN_WITHDRAWAL_FAUCETPAY = 0.10; // $0.10 FaucetPay uchun
    
    const withdrawTypeSelect = document.getElementById("withdrawType");
    const uzcardHumoFields = document.getElementById("uzcardHumoFields");
    const faucetpayFields = document.getElementById("faucetpayFields");
    const amountInput = document.getElementById("amount");
    const minAmountInfo = document.getElementById("minAmountInfo");

    // Yechib olish turi tanlanganda maydonlarni ko'rsatish
    withdrawTypeSelect.addEventListener("change", function() {
        uzcardHumoFields.style.display = 'none';
        faucetpayFields.style.display = 'none';
        amountInput.value = ''; // Miqdorni tozala
        amountInput.min = '0.01'; // Minimal qiymatni boshlang'ich holatga qaytarish

        const type = this.value;
        if (type === "uzcard_humo") {
            uzcardHumoFields.style.display = 'block';
            amountInput.placeholder = `Miqdor (USDT) - Min: ${MIN_WITHDRAWAL_CARD.toFixed(2)}`;
            amountInput.min = MIN_WITHDRAWAL_CARD.toFixed(2);
            minAmountInfo.innerHTML = `Minimal yechish miqdori: **${MIN_WITHDRAWAL_CARD.toFixed(2)} USDT**`;
        } else if (type === "faucetpay") {
            faucetpayFields.style.display = 'block';
            amountInput.placeholder = `Miqdor (USDT) - Min: ${MIN_WITHDRAWAL_FAUCETPAY.toFixed(2)}`;
            amountInput.min = MIN_WITHDRAWAL_FAUCETPAY.toFixed(2);
            minAmountInfo.innerHTML = `Minimal yechish miqdori: **${MIN_WITHDRAWAL_FAUCETPAY.toFixed(2)} USDT**`;
        } else {
            amountInput.placeholder = `Miqdor (USDT)`;
            minAmountInfo.innerHTML = `Minimal yechish miqdori: **Tanlang**`;
        }
    });

    document.getElementById("withdrawForm").addEventListener("submit", function(e){
        e.preventDefault();
        
        const type = withdrawTypeSelect.value;
        const amount = parseFloat(amountInput.value);
        let recipient; 
        let minAmount;
        let recipientType; 
        
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; 
        const cardPattern = /^\d{16}$/; // 16 raqamli karta raqami
        
        if (type === "uzcard_humo") {
            recipient = document.getElementById("cardNumber").value.trim();
            recipientType = "Uzcard/Humo";
            minAmount = MIN_WITHDRAWAL_CARD;
            if (!cardPattern.test(recipient)) {
                alert("Iltimos, Humo yoki Uzcard uchun 16 raqamli toâ€˜gâ€˜ri karta raqamini kiriting.");
                return;
            }
        } else if (type === "faucetpay") {
            recipient = document.getElementById("faucetpayEmail").value.trim();
            recipientType = "FaucetPay E-mail";
            minAmount = MIN_WITHDRAWAL_FAUCETPAY;
            if (!emailPattern.test(recipient)) {
                alert("Please enter a valid FaucetPay Email Address..");
                return;
            }
        } else {
            alert("Please select a withdrawal type..");
            return;
        }

        if (amount <= 0 || isNaN(amount)) {
            alert("Please enter the correct amount..");
            return;
        }
        
        if (amount < minAmount) {
            alert(`Minimal yechib olish miqdori ${minAmount.toFixed(2)} USDT ni tashkil qiladi.`);
            return;
        }

        // Foydalanuvchi balansini tekshirish
        get(child(dbRef, "users/"+deviceId)).then((snapshot) => {
            if (snapshot.exists()) {
                const userData = snapshot.val();
                const currentBalance = parseFloat(userData.balance) || 0.00;

                if (amount > currentBalance) {
                    alert("Your balance is insufficient. Your balance: " + currentBalance.toFixed(4) + " USDT");
                    return;
                }
                
                // Balans yetarli bo'lsa:
                const newBalance = currentBalance - amount;
                const newBalanceString = newBalance.toFixed(4);

                // 1. Balansni kamaytirishni boshlash
                update(ref(db, "users/" + deviceId), { balance: newBalanceString })
                .then(() => {
                    // 2. Balans muvaffaqiyatli kamaytirilsa, so'rovni yuborish
                    const withdrawData = {
                        deviceId: deviceId,
                        recipient_type: type, // Yangi maydon: 'uzcard_humo' yoki 'faucetpay'
                        recipient: recipient, // Karta raqami yoki E-mail
                        amount: amount.toFixed(4), 
                        status: "pending", 
                        timestamp: Date.now()
                    };

                    return push(ref(db, "withdrawRequests"), withdrawData);
                })
                .then(() => {
                    // Ikkala amal ham muvaffaqiyatli yakunlansa
                    alert(`Request sent successfully: ${amount.toFixed(4)} USDT ${recipientType} ga: ${recipient}. Your balance has been updated.`);
                    // Maydonlarni tozalash
                    document.getElementById("cardNumber").value = "";
                    document.getElementById("faucetpayEmail").value = "";
                    amountInput.value = "";
                    withdrawTypeSelect.value = "";
                    withdrawTypeSelect.dispatchEvent(new Event('change')); // Maydonlarni yashirish uchun
                })
                .catch((error) => {
                    // Tranzaksiyaning istalgan bosqichida xato yuz bersa
                    console.error("Tranzaksiyada xatolik:", error);
                    alert("So'rovni amalga oshirishda texnik xatolik yuz berdi. Iltimos, adminga murojaat qiling. Pul balansdan ayirilmagan bo'lishi KAFOLATLANMAYDI.");
                });
                
            } else {
                alert("Balans ma'lumotlari topilmadi. Iltimos, index.html orqali qayta urinib ko'ring.");
            }
        }).catch((error) => {
            console.error(error);
            alert("Ma'lumotlar bazasiga ulanishda xatolik.");
        });
    });

    // Sahifa yuklanganda vaqtinchalik yashirish
    withdrawTypeSelect.dispatchEvent(new Event('change'));
</script>
</body>
</html>