<!DOCTYPE html>
<html lang="uz">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <title>Spot Trading | Rocket Mining</title>
    
    <style>
        /* ========================================================== */
        /* =========== YANADA FUTURISTIK TRADING STILI ============== */
        /* ========================================================== */

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0d0d1e; /* Chuqur ko'k-qora koinot foni */
            color: #e0f7fa; 
            text-align: center;
            padding: 0;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 20px;
        }

        /* Umumiy konteynerlar uchun futuristik shaffof stil */
        .container, .trading-box, .order-form {
            background: rgba(13, 13, 30, 0.85); /* Koinot foni + shaffoflik */
            border: 1px solid #00d2ff; /* Yorqin ko'k chegara */
            border-radius: 20px; 
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.4); 
            padding: 15px;
            margin-top: 15px;
            width: 95%;
            max-width: 550px; /* Umumiy konteyner kattalashtirildi */
            box-sizing: border-box;
            backdrop-filter: blur(8px); 
        }
        
        /* Orqaga Qaytish Tugmasi */
        .back-btn {
            margin-top: 20px;
            padding: 8px 15px;
            background: #1a237e;
            color: #bbdefb;
            border: 1px solid #3a75b7;
            border-radius: 10px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.2s;
            box-shadow: 0 0 10px rgba(58, 117, 183, 0.3);
        }
        
        .back-btn:active {
            transform: scale(0.98);
        }

        /* Sarlavha */
        h2 {
            color: #a7ffeb; 
            text-shadow: 0 0 10px rgba(167, 255, 235, 0.8);
            margin-bottom: 20px;
            font-size: 26px;
        }

        /* Balans Qutisi (Neon yoritish) */
        .balance-info {
            padding: 15px;
            background: #1a237e;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #4fc3f7;
            text-align: left;
            box-shadow: 0 0 15px rgba(79, 195, 247, 0.6);
        }

        .balance-info div {
            font-size: 13px;
            color: #bbdefb;
            text-transform: uppercase;
        }

        .balance-info span {
            font-size: 24px;
            font-weight: bold;
            color: #ffeb3b; 
            text-shadow: 0 0 5px #ffeb3b;
            display: block;
            margin-top: 3px;
            margin-bottom: 10px;
            /* Narx uzun bo'lsa, sig'ishi uchun kichikroq shrift va oqimni sindirish */
            overflow-wrap: break-word; 
            word-wrap: break-word;
            font-size: 20px; 
        }

        /* Narx Ko'rsatkichi */
        .price-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 2px solid #1e0d30;
        }

        .price-details {
            text-align: left;
        }
        
        .price-title-symbol {
            font-size: 14px;
            color: #7986cb;
            display: block;
        }

        .current-price {
            font-size: 36px; 
            font-weight: bold;
            color: #a7ffeb; 
            text-shadow: 0 0 10px rgba(167, 255, 235, 0.7);
            /* Narx aniqligi oshganda sig'ishi uchun kichikroq shrift */
            font-size: 28px; 
            overflow-wrap: break-word;
            word-wrap: break-word;
        }
        
        /* O'zgarish foizi stili */
        .price-change-container {
            text-align: right;
        }

        .price-change-title {
            font-size: 12px;
            color: #7986cb;
            margin-bottom: 3px;
        }

        .price-change {
            font-size: 18px;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.5s;
        }

        /* ========================================= */
        /* =========== KANDEL GRAFIK STILI ========= */
        /* ========================================= */

        .chart-container {
            height: 250px; /* Balandligi ancha oshirildi */
            width: 100%;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow-x: auto; /* Gorizontal aylantirish */
            overflow-y: hidden;
            position: relative;
            box-shadow: inset 0 0 10px rgba(0, 210, 255, 0.2);
            /* Qo'lda surish uchun kursor */
            cursor: grab; 
        }
        
        .chart-container:active {
            cursor: grabbing;
        }
        
        #candlestick-chart {
            display: flex;
            align-items: flex-end; /* Kandellarni pastdan boshlash */
            height: 100%;
            padding: 5px;
            /* Kandellar ko'payganda gorizontal surish ishlashi uchun minimum kenglik kerak */
            min-width: 100%; 
            box-sizing: border-box;
            justify-content: flex-start; /* Chapdan boshlash (yangi kandel o'ngda bo'lishi uchun) */
        }
        
        .candlestick {
            width: 8px; /* Kandel kengligi */
            margin: 0 1px; /* Oraliq */
            position: relative;
            height: 100%;
            flex-shrink: 0; /* Kichrayishga yo'l qo'ymaydi */
        }

        .candlestick .wick {
            position: absolute;
            width: 1px;
            background: #e0f7fa;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .candlestick .body {
            position: absolute;
            width: 100%;
            border: 1px solid transparent;
            box-sizing: border-box;
            left: 0;
            cursor: pointer;
        }

        /* Ko'tarilish (Yashil) */
        .candlestick.up .body {
            background: #00c16e; 
            border-color: #00c16e;
        }
        
        .candlestick.up .wick {
             background: #00c16e;
        }

        /* Tushish (Qizil) */
        .candlestick.down .body {
            background: #FF5722; 
            border-color: #FF5722;
        }
        
        .candlestick.down .wick {
             background: #FF5722;
        }

        .chart-overlay {
             position: absolute;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             color: #7986cb;
             font-size: 12px;
             padding: 10px;
             text-align: right;
             box-sizing: border-box;
             pointer-events: none;
             z-index: 10;
        }

        /* ========================================= */
        /* =========== Savdo shakli stili (O'zgarmagan) */
        /* ========================================= */

        .order-form {
            padding-top: 15px;
        }

        .order-type-tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            overflow: hidden;
            border: 1px solid #3a75b7;
        }

        .order-tab {
            flex: 1;
            padding: 12px 0;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            color: #bbdefb;
        }

        .order-tab.active {
            color: #111;
            background: linear-gradient(90deg, #00d2ff, #a7ffeb);
            box-shadow: inset 0 0 10px rgba(0, 210, 255, 0.7);
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #ffeb3b; 
            text-shadow: 0 0 3px rgba(255, 235, 59, 0.5);
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #7b1fa2; 
            border-radius: 10px;
            background: #1e0d30;
            color: #a7ffeb; 
            font-size: 18px;
            box-sizing: border-box;
            box-shadow: inset 0 0 8px rgba(123, 31, 162, 0.7);
            outline: none;
        }

        .trade-btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .buy-btn {
            background: linear-gradient(45deg, #4CAF50, #00c16e); 
            color: white;
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
        }

        .sell-btn {
            background: linear-gradient(45deg, #FF5722, #e64a19); 
            color: white;
            box-shadow: 0 6px 20px rgba(255, 87, 34, 0.6);
        }

        .trade-btn:active {
            transform: translateY(3px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.5);
        }

    </style>
</head>
<body>

    <a href="index.html" class="back-btn">‚¨ÖÔ∏è Back to main</a>

    <div class="container">
        <h2>üöÄ Spot Trading: RC/USDT</h2>

        <div class="balance-info">
            <div>USDT Your balance</div>
            <span id="usdt-balance">0.0000 USDT</span>
            
            <div>Your RC Balance (Rocket Coin)</div>
            <span id="rc-balance">0.0000 RC</span>
        </div>

        <div class="trading-box">
            <div class="price-display">
                <div class="price-details">
                    <span class="price-title-symbol">RC/USDT</span>
                    <div class="current-price" id="current-price">0.0500</div>
                </div>
                
                <div class="price-change-container">
                    <div class="price-change-title">24h Change</div>
                    <div class="price-change" id="price-change">+0.00%</div>
                </div>
            </div>

            <div class="chart-container" id="chart-container">
                <div class="chart-overlay">
                     <p>AI Narx Harakati</p>
                     </div>
                <div id="candlestick-chart">
                    </div>
            </div>
        </div>

        <div class="order-form">
            <div class="order-type-tabs">
                <div class="order-tab active" data-type="buy" id="tab-buy">(BUY)</div>
                <div class="order-tab" data-type="sell" id="tab-sell">(SELL)</div>
            </div>

            <div id="buy-form">
                <div class="input-group">
                    <label for="buy-amount">Quantity (RC)</label>
                    <input type="number" id="buy-amount" placeholder="The amount of RC..." min="0.0001" step="0.0001">
                </div>
                <div class="input-group">
                    <label>General (USDT)</label>
                    <input type="text" id="buy-total-usdt" placeholder="Calculated..." disabled>
                </div>
                <button class="trade-btn buy-btn" onclick="executeTrade('buy')">RC Purchase</button>
            </div>
            
            <div id="sell-form" style="display: none;">
                <div class="input-group">
                    <label for="sell-amount">Quantity (RC)</label>
                    <input type="number" id="sell-amount" placeholder="The amount of RC..." min="0.0001" step="0.0001">
                </div>
                <div class="input-group">
                    <label>Acceptable (USDT)</label>
                    <input type="text" id="sell-total-usdt" placeholder="Calculated..." disabled>
                </div>
                <button class="trade-btn sell-btn" onclick="executeTrade('sell')">RC Sales</button>
            </div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, get, child, update, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // === FIREBASE KONFIGURATSIYASI ===
        const firebaseConfig = {
          apiKey: "AIzaSyDIeG8dVbm0Yk7FR1hPzrBoD7rgDKWAFoY",
          authDomain: "user1111-c84a0.firebaseapp.com",
          databaseURL: "https://user1111-c84a0-default-rtdb.firebaseio.com",
          projectId: "user1111-c84a0",
          storageBucket: "user1111-c84a0.firebaseapp.com",
          messagingSenderId: "901723757936",
          appId: "1:901723757936:web:9da0a1c7ec494f4a0c03b5",
          measurementId: "G-9R8ZQY63B1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db);
        
        let deviceId = localStorage.getItem("deviceId");
        if(!deviceId){
            // Foydalanuvchi ID ni o'rnatish, masalan, Telegram user ID
            deviceId = "user_" + Math.random().toString(36).substring(2, 9); 
            localStorage.setItem("deviceId", deviceId);
        }
        
        let userBalanceUSDT = 0; 
        let userBalanceRC = 0;   
        
        let currentRCPrice = 0.0500; 
        let dayOpenPrice = 0.0500; 
        let candleData = []; 
        let currentCandle = null;
        
        const MAX_CANDLES = 24; 
        
        // Narx Firebase yo'li
        const PRICE_DATA_REF = ref(db, 'price_data/rc_usdt');

        const usdtBalanceEl = document.getElementById('usdt-balance');
        const rcBalanceEl = document.getElementById('rc-balance');
        const priceEl = document.getElementById('current-price');
        const priceChangeEl = document.getElementById('price-change');
        const candlestickChartEl = document.getElementById('candlestick-chart');
        const chartContainerEl = document.getElementById('chart-container'); 

        // =============================================================
        // =========== FIREBASE TINGLOVCHISI VA EKRAN MANTIQI ==========
        // =============================================================
        
        // Narxning kasr qismi uzunligini aniqlash yordamchi funksiyasi
        // Maksimal 10 kasr aniqligini qaytaradi, chunki undan ko'pi ekranga sig'masligi mumkin
        function getDisplayDecimalPlaces(num) {
            const match = ('' + num).match(/(?:\.(\d+))?(?:[eE]([+-]?\d+))?$/);
            if (!match) { return 4; } // Default 4
            const actualDecimals = Math.max(0, 
                (match[1] ? match[1].length : 0) - 
                (match[2] ? +match[2] : 0));
            
            // Minimal 4, maksimal 10 kasr aniqligini saqlaymiz.
            return Math.min(10, Math.max(4, actualDecimals)); 
        }

        function renderPriceData(data) {
             if (!data) return;

             currentRCPrice = data.currentPrice || 0.0500;
             dayOpenPrice = data.dayOpenPrice || 0.0500;
             
             // Kandel ma'lumotlarini to'liq obyektlarga aylantirish
             const loadedCandleData = (data.candles || []).map(c => ({
                open: c.o,
                high: c.h,
                low: c.l,
                close: c.c
             }));
             candleData = loadedCandleData;
             
             if (candleData.length > 0) {
                currentCandle = candleData[candleData.length - 1];
             } else {
                 currentCandle = null;
             }
             
             // Narxni ekranda yangilash
             // Narxni dinamik ravishda to'g'ri kasr aniqligi bilan ko'rsatish
             const priceDecimals = getDisplayDecimalPlaces(currentRCPrice);
             priceEl.innerText = parseFloat(currentRCPrice).toFixed(priceDecimals);
            
             // 24h Foiz o'zgarishini hisoblash va ekranda yangilash
             const changePercent = ((currentRCPrice - dayOpenPrice) / dayOpenPrice) * 100;
             priceChangeEl.innerText = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
             if (changePercent >= 0) {
                  priceChangeEl.style.color = '#00c16e'; 
                  priceChangeEl.style.backgroundColor = 'rgba(0, 193, 110, 0.2)';
             } else {
                  priceChangeEl.style.color = '#FF5722'; 
                  priceChangeEl.style.backgroundColor = 'rgba(255, 87, 34, 0.2)';
             }
             
             updateCandlestickChart();
             updateOrderTotals();
        }


        // Firebase tinglovchisini o'rnatish (Hamma uchun)
        function setupPriceListener() {
             onValue(PRICE_DATA_REF, (snapshot) => {
                 const data = snapshot.val();
                 if (data) {
                     renderPriceData(data);
                 } else {
                     console.log("Narx ma'lumotlari hali o'rnatilmagan. Admin panel kutilmoqda.");
                 }
             }, {
                 onlyOnce: false 
             });
        }
        
        function updateCandlestickChart() {
            candlestickChartEl.innerHTML = ''; 
            
            const chartHeightPx = 250; 
            
            if (candleData.length === 0) return;
            
            // Dinamik narx chegaralarini aniqlash (cheklanmagan narx uchun)
            const allPrices = candleData.flatMap(c => [c.open, c.high, c.low, c.close]);
            const dynamicMinPrice = Math.min(...allPrices);
            const dynamicMaxPrice = Math.max(...allPrices);
            
            // Grafikda eng yuqori va eng past narx orasidagi diapazon
            let dynamicPriceRange = dynamicMaxPrice - dynamicMinPrice;

            // Agar diapazon juda kichik bo'lsa (deyarli o'zgarish bo'lmasa), chizish uchun minimum diapazon qo'shamiz
            if (dynamicPriceRange < 0.000000001) { // Juda kichik diapazonni ancha kichik qildik
                dynamicPriceRange = 0.000000001; 
            }
            
            // Masshtab koeffitsiyenti
            const scaleFactor = chartHeightPx / dynamicPriceRange; 
            
            // Kandel kengligi va oralig'i (9px) * MAX_CANDLES (24) = 216px minimal kenglik
            const minChartWidth = (9 * MAX_CANDLES); 
            
            // Agar kandelar konteynerdan kam bo'lsa, surishga ruxsat berish uchun kenglikni oshiramiz
            if (chartContainerEl.clientWidth < minChartWidth) {
                 candlestickChartEl.style.minWidth = minChartWidth + 'px';
            } else {
                 candlestickChartEl.style.minWidth = '100%';
            }


            candleData.forEach(candle => {
                const candleEl = document.createElement('div');
                candleEl.classList.add('candlestick');
                
                const isUp = candle.close >= candle.open;
                candleEl.classList.add(isUp ? 'up' : 'down');
                
                // === KANDELNI TO'G'RI CHIZISH UCHUN YANGILANGAN MANTIQ ===
                
                // 1. Kandel tanasi (Body)
                const bodyHeight = Math.abs(candle.close - candle.open) * scaleFactor;
                const bodyBottomPrice = Math.min(candle.open, candle.close); 
                
                // Body ni grafikdagi joylashuvi (dynamicMinPrice ga nisbatan)
                const bodyBottomPosition = (bodyBottomPrice - dynamicMinPrice) * scaleFactor; 

                const bodyEl = document.createElement('div');
                bodyEl.classList.add('body');
                // Balandligi: 1px dan kam bo'lmasligi kerak
                bodyEl.style.height = Math.max(1, bodyHeight) + 'px'; 
                // Pastki qismning joylashuvi
                bodyEl.style.bottom = bodyBottomPosition + 'px'; 
                
                // 2. Kandel ipi (Wick)
                const wickEl = document.createElement('div');
                wickEl.classList.add('wick');
                
                const wickHeight = (candle.high - candle.low) * scaleFactor;
                const wickBottomPosition = (candle.low - dynamicMinPrice) * scaleFactor; 
                
                wickEl.style.height = wickHeight + 'px';
                wickEl.style.bottom = wickBottomPosition + 'px'; 
                
                // ==========================================================

                candleEl.appendChild(wickEl);
                candleEl.appendChild(bodyEl);
                candlestickChartEl.appendChild(candleEl);
            });
            
            // Eng so'nggi kandelni ko'rsatish uchun gorizontal aylantirish
            chartContainerEl.scrollLeft = chartContainerEl.scrollWidth;
        }

        // =============================================================
        // === CHARTNI SURISH FUNKSIYASI (Drag-to-Scroll) ===============
        // =============================================================
        
        let isDragging = false;
        let startX;
        let scrollLeft;

        // Sichqoncha/barmoq bosilganda
        chartContainerEl.addEventListener('mousedown', (e) => {
            isDragging = true;
            chartContainerEl.classList.add('active'); 
            startX = e.pageX - chartContainerEl.offsetLeft;
            scrollLeft = chartContainerEl.scrollLeft;
            e.preventDefault(); 
        });

        // Mobil qurilmalar uchun
        chartContainerEl.addEventListener('touchstart', (e) => {
            isDragging = true;
            startX = e.touches[0].pageX - chartContainerEl.offsetLeft;
            scrollLeft = chartContainerEl.scrollLeft;
        });

        // Sichqoncha/barmoq qo'yib yuborilganda
        chartContainerEl.addEventListener('mouseleave', () => {
            isDragging = false;
            chartContainerEl.classList.remove('active');
        });
        chartContainerEl.addEventListener('mouseup', () => {
            isDragging = false;
            chartContainerEl.classList.remove('active');
        });
        chartContainerEl.addEventListener('touchend', () => {
            isDragging = false;
        });

        // Sichqoncha harakatlanganda
        chartContainerEl.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            const x = e.pageX - chartContainerEl.offsetLeft;
            const walk = (x - startX) * 1.5; 
            chartContainerEl.scrollLeft = scrollLeft - walk;
        });

        // Mobil harakat
        chartContainerEl.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            // e.preventDefault() olib tashlandi, surishni bloklamaslik uchun
            const x = e.touches[0].pageX - chartContainerEl.offsetLeft;
            const walk = (x - startX) * 1.5;
            chartContainerEl.scrollLeft = scrollLeft - walk;
        });


        // =============================================================
        // === QOLGAN FUNKSIYALAR (Balanslar aniqligi yangilandi) =======
        // =============================================================
        
        window.executeTrade = function(type) { 
            let amountEl = document.getElementById(`${type}-amount`);
            let amountRC = parseFloat(amountEl.value);

            if (isNaN(amountRC) || amountRC <= 0) {
                alert("Please enter the correct amount..");
                return;
            }
            const totalUSDT = amountRC * currentRCPrice;
            
            // Kasr aniqligini aniqlash (maksimal 8)
            const tradeDecimals = Math.min(8, Math.max(4, getDisplayDecimalPlaces(totalUSDT)));

            if (type === 'buy') {
                if (userBalanceUSDT < totalUSDT) {
                    alert(`Balansingizda ${totalUSDT.toFixed(tradeDecimals)} Not enough USDT! Available: ${userBalanceUSDT.toFixed(4)} USDT.`);
                    return;
                }
                userBalanceUSDT -= totalUSDT;
                userBalanceRC += amountRC;
                alert(`Successful: ${amountRC.toFixed(tradeDecimals)} RC purchased for ${totalUSDT.toFixed(tradeDecimals)} USDT.`);
            } else if (type === 'sell') {
                if (userBalanceRC < amountRC) {
                    alert(`Your RC balance is ${amountRC.toFixed(tradeDecimals)} RC insufficient! Available: ${userBalanceRC.toFixed(4)} RC.`);
                    return;
                }
                userBalanceRC -= amountRC;
                userBalanceUSDT += totalUSDT; 
                alert(`Successful: ${amountRC.toFixed(tradeDecimals)} RC sold for ${totalUSDT.toFixed(tradeDecimals)} USDT.`);
            }

            updateBalanceDisplay();
            saveBalancesToFirebase(); 
            
            amountEl.value = '';
            document.getElementById(`${type}-total-usdt`).value = '';
        };

        function updateOrderTotals() {
             const buyAmountEl = document.getElementById('buy-amount');
             const sellAmountEl = document.getElementById('sell-amount');
             const buyTotalEl = document.getElementById('buy-total-usdt');
             const sellTotalEl = document.getElementById('sell-total-usdt');
             
             // Maksimal 8 kasr aniqligini ishlatamiz
             const maxTradeDecimals = 8;
             
             const buyAmountRC = parseFloat(buyAmountEl.value);
             if (!isNaN(buyAmountRC) && buyAmountRC > 0) {
                 buyTotalEl.value = (buyAmountRC * currentRCPrice).toFixed(maxTradeDecimals);
             } else {
                 buyTotalEl.value = '';
             }

             const sellAmountRC = parseFloat(sellAmountEl.value);
             if (!isNaN(sellAmountRC) && sellAmountRC > 0) {
                 sellTotalEl.value = (sellAmountRC * currentRCPrice).toFixed(maxTradeDecimals);
             } else {
                 sellTotalEl.value = '';
             }
        }
        
        document.getElementById('buy-amount').addEventListener('input', updateOrderTotals);
        document.getElementById('sell-amount').addEventListener('input', updateOrderTotals);

        function updateBalanceDisplay() {
            // Balanslar uchun ham yuqori aniqlik (maksimal 8)
            const balanceDecimals = 8;
            usdtBalanceEl.innerText = userBalanceUSDT.toFixed(balanceDecimals) + " USDT";
            rcBalanceEl.innerText = userBalanceRC.toFixed(balanceDecimals) + " RC";
        }

        function saveBalancesToFirebase() {
             // Saqlashda ham yuqori aniqlik (maksimal 8)
             const saveDecimals = 8;
             update(ref(db, "users/" + deviceId), {
                balance: userBalanceUSDT.toFixed(saveDecimals), 
                rc_balance: userBalanceRC.toFixed(saveDecimals) 
             });
        }

        function loadBalancesFromFirebase() {
            get(child(dbRef, "users/" + deviceId)).then(snapshot => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    // Firebase'dan yuklashda to'liq aniqlikni saqlash
                    userBalanceUSDT = parseFloat(data.balance) || 0; 
                    userBalanceRC = parseFloat(data.rc_balance) || 0; 
                    updateBalanceDisplay();
                } else {
                    update(ref(db, "users/" + deviceId), { 
                        balance: "0.0000", 
                        rc_balance: "0.0000" 
                    });
                    updateBalanceDisplay();
                }
            }).catch(error => {
                console.error("Balanslarni yuklashda xatolik:", error);
            });
        }
        
        document.getElementById('tab-buy').addEventListener('click', () => {
            document.getElementById('tab-buy').classList.add('active');
            document.getElementById('tab-sell').classList.remove('active');
            document.getElementById('buy-form').style.display = 'block';
            document.getElementById('sell-form').style.display = 'none';
        });

        document.getElementById('tab-sell').addEventListener('click', () => {
            document.getElementById('tab-buy').classList.remove('active');
            document.getElementById('tab-sell').classList.add('active');
            document.getElementById('buy-form').style.display = 'none';
            document.getElementById('sell-form').style.display = 'block';
        });

        // === INIT ===
        function initTradingApp() {
            loadBalancesFromFirebase(); 
            setupPriceListener(); 
        }

        window.onload = initTradingApp;

    </script>
</body>
</html>
